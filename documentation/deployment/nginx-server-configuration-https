sudo tee /etc/nginx/sites-available/cgsappki << EOF
# App 1 - Port 8080 端ber Standard HTTPS Port 443
server {
    listen 8443 ssl;
    server_name cgsappki-intern;

    ssl_certificate /home/$USER/server.crt;
    ssl_certificate_key /home/$USER/server.key;

    # Mixed Content Fix
    add_header Content-Security-Policy "upgrade-insecure-requests" always;

    location / {
        proxy_pass http://localhost:8050;
        proxy_set_header Host \$host:8443;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host \$host:8443;
        proxy_set_header X-Forwarded-Port 8443;

        # URL-Korrektur f端r Static Files
        sub_filter 'src="/static/' 'src="/static/';
        sub_filter 'href="/static/' 'href="/static/';
        sub_filter 'https://cgsappki/' 'https://cgsappki:8443/';
        sub_filter 'http://cgsappki/' 'https://cgsappki:8443/';
        sub_filter_once off;
        sub_filter_types text/html application/javascript text/css application/json;

        proxy_redirect off;
    }
}

# App 2 - Port 8050 端ber HTTPS Port 8444 mit URL-Korrektur
server {
    listen 8444 ssl;
    server_name cgsappki-qs;

    ssl_certificate /home/$USER/server.crt;
    ssl_certificate_key /home/$USER/server.key;

    add_header Content-Security-Policy "upgrade-insecure-requests" always;

    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host \$host:8444;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host \$host:8444;
        proxy_set_header X-Forwarded-Port 8444;

        # URL-Korrektur f端r Static Files
        sub_filter 'src="/static/' 'src="/static/';
        sub_filter 'href="/static/' 'href="/static/';
        sub_filter 'https://cgsappki/' 'https://cgsappki:8444/';
        sub_filter 'http://cgsappki/' 'https://cgsappki:8444/';
        sub_filter_once off;
        sub_filter_types text/html application/javascript text/css application/json;

        proxy_redirect off;
    }
}
EOF


sudo nginx -t
sudo systemctl reload nginx
