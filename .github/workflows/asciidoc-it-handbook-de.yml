

name: Build IT-Handbook de html, pdf, docx

on:
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'
        required: true
        default: 'warning'
        type: choice
        options:
          - info
          - warning
          - debug
      pdfTheme:
        description: 'Asciidoctor PDF Theme'
        required: true
        default: 'CGS'
        type: choice
        options:
          - CGS
          - ARC
      outputType:
        description: 'Output type: 0=it-req(default), 1=small, 2=large'
        required: true
        default: '0'
        type: choice
        options:
          - 0
          - 1
          - 2
      version:
        description: 'Asciidoctor PDF Version'
        required: true
        default: '1.4.0'
        type: string

  
env:
  FILENAME: 'IT_HANDBOOK_DE'
  FILEPATH: 'it_manual/de'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Asciidoctor & Asciidoctor-pdf
        run: |
          sudo gem install asciidoctor asciidoctor-pdf

      - name: Setup Pandoc
        uses: r-lib/actions/setup-pandoc@v2
        with:
          pandoc-version: '3.1.6.2'

      - name: Install envsubst (gettext)
        run: sudo apt-get update && sudo apt-get install -y gettext

      - name: Define metadata variables
        run: |
          # Setze Titel/Autor/Anwendung dynamisch
          if [ "${{ github.event.inputs.pdfTheme }}" = "ARC" ]; then
            echo "PRODUCT_TITLE=AI Audit Assist: IT-Handbuch" >> $GITHUB_ENV
            echo "AUTHOR=ARC Institute" >> $GITHUB_ENV
            echo "APPLICATION=AI Audit Assist" >> $GITHUB_ENV
            echo "ARC-ASSIST=1" >> $GITHUB_ENV
            echo "CGS-ASSIST=0" >> $GITHUB_ENV
          else
            echo "PRODUCT_TITLE=CGS Assist: Software fÃ¼r den Mittelstand - IT-Handbuch" >> $GITHUB_ENV
            echo "AUTHOR=CGS mbH" >> $GITHUB_ENV
            echo "APPLICATION=CGS Assist" >> $GITHUB_ENV
            echo "ARC-ASSIST=0" >> $GITHUB_ENV
            echo "CGS-ASSIST=1" >> $GITHUB_ENV
          fi
          echo "REVNUMBER=${{ github.event.inputs.version }}" >> $GITHUB_ENV
          echo "BIG_OUTPUT=${{ github.event.inputs.outputType }}" >> $GITHUB_ENV
          # Setze Unternehmen statisch
          echo "COMPANY=Example AG" >> $GITHUB_ENV
          # Setze Tagesdatum im deutschen Format
          echo "DATE=$(date '+%d.%m.%Y')" >> $GITHUB_ENV

      - name: Fill metadata template
        run: |
          envsubst < ${{ env.FILEPATH }}/metadata.yml.tpl > ${{ env.FILEPATH }}/metadata.yml

      - name: Build HTML with Asciidoctor
        run: |
          asciidoctor \
            -D ${{ env.FILEPATH }}/ \
            -a product_title="${{ env.PRODUCT_TITLE }}" \
            -a revnumber="${{ env.REVNUMBER }}" \
            -a application="${{ env.APPLICATION }}" \
            -a author="${{ env.AUTHOR }}" \
            -a big-output="${{ env.BIG_OUTPUT }}" \
            -a company="${{ env.COMPANY }}" \
            -a date="${{ env.DATE }}" \
            -a cgs-assist="${{ env.CGS-ASSIST }}" \
            -a arc-assist="${{ env.ARC-ASSIST }}" \
            -a pdf-theme="${{ github.event.inputs.pdfTheme }}" \
            -o ${{ env.FILENAME }}_Typ_${{ env.BIG_OUTPUT }}_v_${{ env.REVNUMBER }}_${{ env.DATE }}.html ${{ env.FILEPATH }}/index.adoc

      - name: Build PDF with Asciidoctor-pdf
        run: |
          asciidoctor-pdf \
           -D ${{ env.FILEPATH }} \
           -a product_title="${{ env.PRODUCT_TITLE }}" \
           -a revnumber="${{ env.REVNUMBER }}" \
           -a application="${{ env.APPLICATION }}" \
           -a author="${{ env.AUTHOR }}" \
           -a big-output="${{ env.BIG_OUTPUT }}" \
           -a company="${{ env.COMPANY }}" \
           -a date="${{ env.DATE }}" \
           -a cgs-assist="${{ env.CGS-ASSIST }}" \
           -a arc-assist="${{ env.ARC-ASSIST }}" \
           -a pdf-theme="${{ github.event.inputs.pdfTheme }}" \
           -a pdf-themesdir=it_manual/themes \
           -o ${{ env.FILENAME }}_Typ_${{ env.BIG_OUTPUT }}_v_${{ env.REVNUMBER }}_${{ env.DATE }}.pdf ${{ env.FILEPATH }}/index.adoc

      - name: Build DOCX with Pandoc von html
        run: |
          pandoc ${{ env.FILENAME }}_Typ_${{ env.BIG_OUTPUT }}_v_${{ env.REVNUMBER }}_${{ env.DATE }}.pdf \
            --metadata-file=${{ env.FILEPATH }}/metadata.yml \
            --resource-path=${{ env.FILEPATH }}  \
            --reference-doc=it_manual/themes/style-reference.docx \
            -o ${{ env.FILEPATH }}/${{ env.FILENAME }}_Typ_${{ env.BIG_OUTPUT }}_v_${{ env.REVNUMBER }}_${{ env.DATE }}.docx
            
      - name: Build DOCX with Pandoc von adoc
        run: |
          pandoc ${{ env.FILEPATH }}/index.adoc \
            --metadata-file=${{ env.FILEPATH }}/metadata.yml \
            --resource-path=${{ env.FILEPATH }}  \
            --reference-doc=it_manual/themes/style-reference.docx \
            -o ${{ env.FILEPATH }}/${{ env.FILENAME }}_Typ_${{ env.BIG_OUTPUT }}_v_${{ env.REVNUMBER }}_${{ env.DATE }}.docx

      - name: Upload documentation artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.FILENAME }}_Typ_${{ env.BIG_OUTPUT }}_${{ env.DATE }}
          path: |
            ${{ env.FILEPATH }}/${{ env.FILENAME }}*.pdf
            ${{ env.FILEPATH }}/${{ env.FILENAME }}*.html
            ${{ env.FILEPATH }}/${{ env.FILENAME }}*.docx
