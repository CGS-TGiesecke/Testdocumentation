

name: Asciidoctor Build User-Handbook de to html, pdf, docx

on:
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'
        required: true
        default: 'warning'
        type: choice
        options:
          - info
          - warning
          - debug
      pdfTheme:
        description: 'Asciidoctor PDF Theme'
        required: true
        default: 'CGS'
        type: choice
        options:
          - CGS
          - ARC
      version:
        description: 'Asciidoctor PDF Version'
        required: true
        default: '1.3.0'
        type: string

  
env:
  FILENAME: 'USER_MANUAL_DE'
  FILEPATH: 'user_manuals/de'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Asciidoctor & Asciidoctor-pdf
        run: |
          sudo gem install asciidoctor asciidoctor-pdf

      - name: Setup Pandoc
        uses: r-lib/actions/setup-pandoc@v2
        with:
          pandoc-version: '3.1.6.2'

      - name: Install envsubst (gettext)
        run: sudo apt-get update && sudo apt-get install -y gettext

      - name: Define metadata variables
        run: |
          # Setze Titel/Autor/Anwendung dynamisch
          if [ "${{ github.event.inputs.pdfTheme }}" = "ARC" ]; then
            echo "PRODUCT_TITLE=AI Audit Assist: Benutzerhandbuch" >> $GITHUB_ENV
            echo "AUTHOR=ARC Institut" >> $GITHUB_ENV
            echo "APPLICATION=AI Audit Assist" >> $GITHUB_ENV
            echo "ARC-ASSIST=1" >> $GITHUB_ENV
            echo "CGS-ASSIST=0" >> $GITHUB_ENV
          else
            echo "PRODUCT_TITLE=CGS Assist: Software fÃ¼r den Mittelstand - Benutzerhandbuch" >> $GITHUB_ENV
            echo "AUTHOR=CGS mbH" >> $GITHUB_ENV
            echo "APPLICATION=CGS Assist" >> $GITHUB_ENV
            echo "ARC-ASSIST=0" >> $GITHUB_ENV
            echo "CGS-ASSIST=1" >> $GITHUB_ENV
          fi
          echo "REVNUMBER=${{ github.event.inputs.version }}" >> $GITHUB_ENV
          echo "BIG_OUTPUT=${{ github.event.inputs.outputType }}" >> $GITHUB_ENV
          # Setze Unternehmen statisch
          echo "COMPANY=Example AG" >> $GITHUB_ENV
          # Setze Tagesdatum im deutschen Format
          echo "DATE=$(date '+%d.%m.%Y')" >> $GITHUB_ENV

      - name: Fill metadata template
        run: |
          envsubst < ${{ env.FILEPATH}}/metadata.yml.tpl > ${{ env.FILEPATH}}/metadata.yml

      - name: Build HTML with Asciidoctor
        run: |
          asciidoctor \
            -D ${{ env.FILEPATH}}/ \
            -a product_title="${{ env.PRODUCT_TITLE }}" \
            -a revnumber="${{ env.REVNUMBER }}" \
            -a application="${{ env.APPLICATION }}" \
            -a author="${{ env.AUTHOR }}" \
            -a big-output="${{ env.BIG_OUTPUT }}" \
            -a company="${{ env.COMPANY }}" \
            -a date="${{ env.DATE }}" \
            -a cgs-assist="${{ env.CGS-ASSIST }}" \
            -a arc-assist="${{ env.ARC-ASSIST }}" \
            -a pdf-theme="${{ github.event.inputs.pdfTheme }}" \
            -a imagesdir=./images  \
            -o ${{ env.FILENAME }}_Typ_${{ env.BIG_OUTPUT }}_v_${{ env.REVNUMBER }}_${{ env.DATE }}.html ${{ env.FILEPATH}}/index.adoc

      - name: Build PDF with Asciidoctor-pdf
        run: |
          asciidoctor-pdf \
           -D ${{ env.FILEPATH}}/ \
           -a product_title="${{ env.PRODUCT_TITLE }}" \
           -a revnumber="${{ env.REVNUMBER }}" \
           -a application="${{ env.APPLICATION }}" \
           -a author="${{ env.AUTHOR }}" \
           -a big-output="${{ env.BIG_OUTPUT }}" \
           -a company="${{ env.COMPANY }}" \
           -a date="${{ env.DATE }}" \
           -a cgs-assist="${{ env.CGS-ASSIST }}" \
           -a arc-assist="${{ env.ARC-ASSIST }}" \
           -a pdf-theme="${{ github.event.inputs.pdfTheme }}" \
           -a pdf-themesdir=user_manuals/themes \
           -o ${{ env.FILENAME }}Typ_${{ env.BIG_OUTPUT }}_v_${{ env.REVNUMBER }}_${{ env.DATE }}.pdf ${{ env.FILEPATH}}/index.adoc

      - name: Build DOCX with Pandoc
        run: |
          pandoc ${{ env.FILEPATH}}/${{ env.FILENAME }}_Typ_${{ env.BIG_OUTPUT }}_v_${{ env.REVNUMBER }}_${{ env.DATE }}.html \
            --metadata-file=${{ env.FILEPATH}}/metadata.yml \
            --resource-path=${{ env.FILEPATH}}  \
            -o ${{ env.FILEPATH}}/${{ env.FILENAME }}_Typ_${{ env.BIG_OUTPUT }}_v_${{ env.REVNUMBER }}_${{ env.DATE }}.docx

      - name: Upload documentation artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.FILENAME }}_${{ env.DATE }}
          path: |
            ${{ env.FILEPATH}}/${{ env.FILENAME }}*.pdf
            ${{ env.FILEPATH}}/${{ env.FILENAME }}*.html
            ${{ env.FILEPATH}}/${{ env.FILENAME }}*.docx
            ${{ env.FILEPATH}}/*
