name: Asciidoctor Build DIFFERENCES de to html, pdf, docx

on:
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'
        required: true
        default: 'warning'
        type: choice
        options:
          - info
          - warning
          - debug
      pdfTheme:
        description: 'Asciidoctor PDF Theme'
        required: true
        default: 'CGS'
        type: choice
        options:
          - CGS
          - ARC
      outputType:
        description: 'Asciidoctor Output type'
        required: true
        default: '0'
        type: choice
        options:
          - 0
          - 1
      version:
        description: 'Asciidoctor PDF Version'
        required: true
        default: '1.0.0'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Asciidoctor & Asciidoctor-pdf
        run: |
          sudo gem install asciidoctor asciidoctor-pdf

      - name: Setup Pandoc
        uses: r-lib/actions/setup-pandoc@v2
        with:
          pandoc-version: '3.1.6.2'

      - name: Install envsubst (gettext)
        run: sudo apt-get update && sudo apt-get install -y gettext

      - name: Define metadata variables
        run: |
          # Setze Titel/Autor/Anwendung dynamisch
          if [ "${{ github.event.inputs.pdfTheme }}" = "ARC" ]; then
            echo "PRODUCT_TITLE=AI Audit Assist: Differenzierungsmerkmale / Vorteile gegenüber MS Copilot bzw. ChatGPT Enterprise Version" >> $GITHUB_ENV
            echo "AUTHOR=AI Audit Institut" >> $GITHUB_ENV
            echo "APPLICATION=AI Audit Assist" >> $GITHUB_ENV
            echo "ARC-ASSIST=1" >> $GITHUB_ENV
            echo "CGS-ASSIST=0" >> $GITHUB_ENV
          else
            echo "PRODUCT_TITLE=CGS Assist: Differenzierungsmerkmale / Vorteile gegenüber MS Copilot bzw. ChatGPT Enterprise Version" >> $GITHUB_ENV
            echo "AUTHOR=CGS mbH" >> $GITHUB_ENV
            echo "APPLICATION=CGS Assist" >> $GITHUB_ENV
            echo "ARC-ASSIST=0" >> $GITHUB_ENV
            echo "CGS-ASSIST=1" >> $GITHUB_ENV
          fi
          echo "REVNUMBER=${{ github.event.inputs.version }}" >> $GITHUB_ENV
          echo "BIG_OUTPUT=${{ github.event.inputs.outputType }}" >> $GITHUB_ENV
          # Setze Unternehmen statisch
          echo "COMPANY=Example AG" >> $GITHUB_ENV
          # Setze Tagesdatum im deutschen Format
          echo "DATE=$(date '+%d.%m.%Y')" >> $GITHUB_ENV

      - name: Fill metadata template
        run: |
          envsubst < documentation/sales_manuals/metadata.yml.tpl > documentation/sales_manuals/metadata.yml

      - name: Build HTML with Asciidoctor
        run: |
          asciidoctor \
            -D documentation/sales_manuals/ \
            -a product_title="${{ env.PRODUCT_TITLE }}" \
            -a revnumber="${{ env.REVNUMBER }}" \
            -a application="${{ env.APPLICATION }}" \
            -a author="${{ env.AUTHOR }}" \
            -a big-output="${{ env.BIG_OUTPUT }}" \
            -a company="${{ env.COMPANY }}" \
            -a date="${{ env.DATE }}" \
            -a cgs-assist="${{ env.CGS-ASSIST }}" \
            -a arc-assist="${{ env.ARC-ASSIST }}" \
            -a pdf-theme="${{ github.event.inputs.pdfTheme }}" \
            -o DIFFERENCES_DE_Typ_${{ env.BIG_OUTPUT }}_Version_${{ env.REVNUMBER }}_${{ env.DATE }}.html \
            documentation/sales_manuals/index.adoc

      - name: Build PDF with Asciidoctor-pdf
        run: |
          asciidoctor-pdf \
           -D documentation/sales_manuals/ \
           -a product_title="${{ env.PRODUCT_TITLE }}" \
           -a revnumber="${{ env.REVNUMBER }}" \
           -a application="${{ env.APPLICATION }}" \
           -a author="${{ env.AUTHOR }}" \
           -a big-output="${{ env.BIG_OUTPUT }}" \
           -a company="${{ env.COMPANY }}" \
           -a date="${{ env.DATE }}" \
           -a cgs-assist="${{ env.CGS-ASSIST }}" \
           -a arc-assist="${{ env.ARC-ASSIST }}" \
           -a pdf-theme="${{ github.event.inputs.pdfTheme }}" \
           -a pdf-themesdir=documentation/sales_manuals/themes \
           -o DIFFERENCES_DE_Typ_${{ env.BIG_OUTPUT }}_Version_${{ env.REVNUMBER }}_${{ env.DATE }}.pdf \
           documentation/sales_manuals/index.adoc

      - name: Build DOCX with Pandoc
        run: |
          pandoc documentation/sales_manuals/DIFFERENCES_DE_Typ_${{ env.BIG_OUTPUT }}_Version_${{ env.REVNUMBER }}_${{ env.DATE }}.html \
            --metadata-file=documentation/sales_manuals/metadata.yml \
            -o documentation/sales_manuals/DIFFERENCES_DE_Typ_${{ env.BIG_OUTPUT }}_Version_${{ env.REVNUMBER }}_${{ env.DATE }}.docx

      - name: Upload documentation artifact
        uses: actions/upload-artifact@v4
        with:
          name: DIFFERENCES_DE
          path: |
            documentation/sales_manuals/DIFFERENCES_DE_*.pdf
            documentation/sales_manuals/DIFFERENCES_DE_*.html
            documentation/sales_manuals/DIFFERENCES_DE_*.docx
